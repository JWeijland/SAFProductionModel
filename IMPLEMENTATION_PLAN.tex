\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[margin=1in]{geometry}
\usepackage{amsmath}
\usepackage{titlesec}
\usepackage{xcolor}
\usepackage{parskip}
\usepackage{listings}
\usepackage{enumitem}

\definecolor{primaryblue}{RGB}{30, 64, 175}
\definecolor{codegray}{RGB}{240, 240, 240}

\titleformat{\section}{\Large\bfseries\color{primaryblue}}{\thesection.}{0.5em}{}
\titleformat{\subsection}{\large\bfseries}{\thesubsection}{0.5em}{}

\lstset{
    backgroundcolor=\color{codegray},
    basicstyle=\ttfamily\small,
    breaklines=true,
    frame=single,
    numbers=left,
    numberstyle=\tiny,
}

\setlength{\parindent}{0pt}
\setlength{\parskip}{0.8em}

\begin{document}

\title{\textbf{Implementation Plan:\\Iterative Feedstock Price Discovery\\with Long-Term Contracts}}
\author{Jelle Weijland}
\date{\today}
\maketitle

\section{Overview}

This document outlines the implementation of an annual 30-day negotiation mechanism where feedstock aggregators and investors discover equilibrium prices through iterative adjustment, resulting in 20-year contracts with partial spot market exposure.

The key innovation is the introduction of long-term contractual relationships that provide stability while maintaining market-driven price discovery and realistic spot market dynamics.

\section{Core Problem: Oversupply and $N_{\text{target}}$}

\subsection{Current Issue}

The naive approach calculates target investors as:
\begin{equation}
N_{\text{target}} = \frac{Q_{\text{aggregator}}}{100{,}000 \text{ tonnes}}
\end{equation}

\textbf{Example: PUNJAB State}
\begin{itemize}
    \item Total supply: 4,787,000 tonnes/year
    \item Naive $N_{\text{target}} = 4{,}787{,}000 / 100{,}000 = 47.8$ investors
\end{itemize}

\textbf{Problem:} The aggregator would be satisfied with just 1-2 investors, not 47. A high $N_{\text{target}}$ means almost all interested investors participate, eliminating competition and resulting in low prices. The aggregator fails to capture value despite having a valuable resource.

\subsection{Solution: Capacity Utilization Fraction}

Apply a time-varying fraction to limit how much capacity the aggregator offers annually:

\begin{equation}
N_{\text{target}} = \frac{Q_{\text{aggregator}} \times f_{\text{util}}(t)}{100{,}000 \text{ tonnes}}
\end{equation}

where $f_{\text{util}}(t)$ is the utilization fraction that evolves over time.

\textbf{Utilization Fraction Strategy:}
\begin{itemize}
    \item \textbf{Years 1--5:} 5--10\% of capacity $\rightarrow$ forces scarcity
    \item \textbf{Years 5--15:} 10--30\% of capacity $\rightarrow$ gradual expansion
    \item \textbf{Years 15+:} 30--60\% of capacity $\rightarrow$ mature market
\end{itemize}

\textbf{PUNJAB Example with Utilization Fraction:}
\begin{align}
\text{Year 1:} \quad & N_{\text{target}} = 4{,}787{,}000 \times 0.05 / 100{,}000 = 2.4 \text{ investors} \quad \text{(intense competition)} \\
\text{Year 10:} \quad & N_{\text{target}} = 4{,}787{,}000 \times 0.20 / 100{,}000 = 9.6 \text{ investors} \quad \text{(moderate competition)} \\
\text{Year 20:} \quad & N_{\text{target}} = 4{,}787{,}000 \times 0.50 / 100{,}000 = 24 \text{ investors} \quad \text{(stable market)}
\end{align}

\textbf{Implementation:}
\begin{lstlisting}[language=Python, caption=Utilization Fraction Function]
def get_utilization_fraction(current_year: int,
                             start_year: int) -> float:
    """
    Returns fraction of aggregator capacity to offer
    based on market maturity.
    Starts low (scarcity) and increases over time
    (market expansion).
    """
    years_elapsed = current_year - start_year
    f_start = 0.05  # 5% in year 1
    f_max = 0.60    # 60% maximum
    growth_rate = 0.03

    f_util = f_start + growth_rate * years_elapsed
    return min(f_util, f_max)
\end{lstlisting}

\textbf{Key Principle:} Behavior emerges naturally from market rules---no hardcoded investor strategies.

\section{Improved Price Convergence Formula}

\subsection{Problem with Linear Approach}

The naive proportional control:
\begin{equation}
\Delta p = -\alpha \times (N_{\text{active}} - N_{\text{target}})
\end{equation}

converges only at discrete multiples of $\alpha$, resulting in ugly step behavior.

\subsection{Solution: Smoothed Proportional Control}

We introduce a dampening factor to smooth convergence:

\begin{equation}
\Delta p = -\alpha \times \frac{N_{\text{active}} - N_{\text{target}}}{1 + \beta \times |N_{\text{active}} - N_{\text{target}}|}
\end{equation}

where:
\begin{itemize}
    \item $\alpha$ = base step size (e.g., 10 USD)
    \item $\beta$ = dampening factor (e.g., 0.1)
\end{itemize}

\textbf{Effect:}
\begin{itemize}
    \item Large errors $\rightarrow$ smaller relative steps (prevents overshoot)
    \item Small errors $\rightarrow$ proportional adjustments (fine-tuning)
\end{itemize}

\textbf{Alternative: Hyperbolic Tangent Dampening}
\begin{equation}
\Delta p = -\alpha \times \tanh\left(\frac{N_{\text{active}} - N_{\text{target}}}{s}\right)
\end{equation}

where $s$ is a scaling parameter. This produces a smooth S-curve response with bounded adjustment magnitude.

\section{Contract Structure}

\subsection{Contract Data Model}

Each feedstock contract is characterized by:

\begin{itemize}[leftmargin=2cm]
    \item[\texttt{contract\_id}:] Unique identifier
    \item[\texttt{investor\_id}:] Contracting investor
    \item[\texttt{aggregator\_id}:] Aggregator (state\_id)
    \item[\texttt{plant\_id}:] Associated production plant
    \item[\texttt{contract\_price}:] Locked-in equilibrium price $p^*$ (USD/tonne)
    \item[\texttt{start\_year}:] Contract commencement year
    \item[\texttt{duration}:] Contract length (default: 20 years)
    \item[\texttt{annual\_capacity}:] Plant's design capacity (tonnes/year)
    \item[\texttt{contract\_percentage}:] Coverage fraction (0.80--0.90)
    \item[\texttt{status}:] Contract state (\texttt{active}, \texttt{expired})
\end{itemize}

\subsection{Key Contractual Rules}

\begin{enumerate}
    \item \textbf{One contract per plant}
    \item \textbf{Investor obligation:} Must purchase at least
    \begin{equation}
    Q_{\text{contract}} = Q_{\text{annual}} \times f_{\text{contract}}
    \end{equation}
    where $f_{\text{contract}} \in [0.80, 0.90]$ is chosen by the investor
    \item \textbf{Aggregator obligation:} Must deliver any amount investor requests within $[0.80, 0.90] \times Q_{\text{annual}}$
    \item \textbf{Spot market:} Remaining 10--20\% purchased at annual average spot price
\end{enumerate}

\section{Iterative Price Discovery Algorithm}

\subsection{Algorithm Overview}

A new module \texttt{src/price\_discovery.py} will implement:

\begin{lstlisting}[language=Python, caption=Price Discovery Function Signature]
def run_price_discovery_negotiation(
    aggregator: FeedstockAggregator,
    interested_investors: List[Investor],
    current_year: int,
    max_days: int = 30,
    initial_price: float = None,
    convergence_threshold: float = 0.01
) -> Dict:
    """
    Runs 30-day iterative negotiation between aggregator
    and investors.

    Returns:
        {
            'final_price': float,
            'winning_investors': List[Investor],
            'daily_prices': List[float],
            'daily_participation': List[int]
        }
    """
\end{lstlisting}

\subsection{Algorithm Flow}

\textbf{Initialization:}
\begin{enumerate}
    \item Calculate $N_{\text{target}}$ using utilization fraction $f_{\text{util}}(t)$
    \item Set initial price $p_0$ (e.g., aggregator's feedstock price + margin)
\end{enumerate}

\textbf{Daily Iteration (Days 1--30):}

For each day $d \in \{1, 2, \ldots, 30\}$:
\begin{enumerate}[label=\alph*)]
    \item Announce current price $p_d$
    \item Each investor $i$ calculates NPV using conventional discounted cash flow formula
    \item Count $N_{\text{active}}$ = number of investors with $\text{NPV}_i > \theta_i$
    \item Update price:
    \begin{align}
    e_d &= N_{\text{active}} - N_{\text{target}} \\
    \Delta p_d &= -\alpha \times \frac{e_d}{1 + \beta \times |e_d|} \\
    p_{d+1} &= p_d + \Delta p_d
    \end{align}
    \item Check convergence: if $|\Delta p_d| < \epsilon$, terminate early
\end{enumerate}

\textbf{Finalization:}
\begin{itemize}
    \item Final equilibrium price: $p^* = p_{30}$ (or earlier if converged)
    \item Winning investors: all investors with $\text{NPV}(p^*) > \theta$
    \item Create contracts for each winning investor's plant
\end{itemize}

\subsection{Integration with Existing Model}

\textbf{Timing:}
\begin{itemize}
    \item Regular simulation step = 1 year (current behavior)
    \item \textbf{NEW:} Before each year's investment phase, run negotiation window
    \item Negotiation = sub-simulation (30 daily iterations)
\end{itemize}

\section{Spot Market Pricing}

\subsection{Annual Spot Price Calculation}

Since multiple investors can invest in the same year from different aggregators, the annual spot price is computed as:

\begin{equation}
p_{\text{spot}}(t) = \frac{1}{M} \sum_{j=1}^{M} p^*_j
\end{equation}

where $M$ is the number of negotiations completed in year $t$, and $p^*_j$ is the final price from negotiation $j$.

\begin{lstlisting}[language=Python, caption=Spot Price Calculation]
def calculate_annual_spot_price(
    all_negotiations_this_year: List[Dict]
) -> float:
    """
    Average all final prices from negotiations that
    occurred this year.

    Args:
        all_negotiations_this_year: List of negotiation
                                    results

    Returns:
        Average final price across all negotiations
    """
    prices = [neg['final_price']
              for neg in all_negotiations_this_year]
    return sum(prices) / len(prices) if prices \
           else default_price
\end{lstlisting}

\textbf{Usage:}
\begin{itemize}
    \item Existing contract holders buy their 10--20\% at this average spot price
    \item Updates annually
    \item Creates natural price volatility
\end{itemize}

\section{Modified Agent Behaviors}

\subsection{Feedstock Aggregator Changes}

\textbf{New Attributes:}
\begin{itemize}
    \item \texttt{active\_contracts}: List of active \texttt{FeedstockContract} objects
    \item \texttt{utilization\_fraction}: Current capacity utilization (calculated annually)
    \item \texttt{negotiation\_history}: Historical record of negotiations
\end{itemize}

\textbf{New Methods:}
\begin{itemize}
    \item \texttt{initiate\_negotiation(year)}: Run price discovery for available capacity
    \item \texttt{allocate\_contracted\_capacity()}: Calculate committed capacity
    \item \texttt{get\_available\_capacity\_for\_negotiation(year)}: \\
    Returns: $Q_{\text{total}} \times f_{\text{util}}(t) - Q_{\text{contracted}}$
\end{itemize}

\subsection{Investor Changes}

\textbf{New Attributes:}
\begin{itemize}
    \item \texttt{contracts}: List of \texttt{FeedstockContract} objects held by investor
\end{itemize}

\textbf{New Methods:}
\begin{itemize}
    \item \texttt{participate\_in\_negotiation(aggregator, proposed\_price)}: \\
    Returns \texttt{True} if $\text{NPV}(p) > \theta$, using conventional NPV calculation
    \item \texttt{decide\_contract\_percentage()}: \\
    Choose coverage $\in [0.80, 0.90]$ (random or simple rule)
    \item \texttt{purchase\_spot\_feedstock(spot\_price)}: \\
    Purchase remaining 10--20\% at annual spot price
\end{itemize}

\subsection{Model Changes}

\textbf{New Attributes:}
\begin{itemize}
    \item \texttt{all\_contracts}: Global list of all contracts
    \item \texttt{annual\_spot\_prices}: Dictionary mapping year $\rightarrow$ spot price
    \item \texttt{negotiation\_results}: Dictionary mapping year $\rightarrow$ list of negotiations
\end{itemize}

\textbf{Modified \texttt{step()} Logic:}
\begin{lstlisting}[language=Python, caption=Modified Model Step Function]
def step(self):
    # ... existing setup ...

    # NEW: Run annual negotiations (before invest phase)
    self.run_annual_negotiations()

    # Calculate spot price for this year
    current_year = year_for_tick(
        self.config['start_year'],
        self.schedule.time
    )
    self.annual_spot_prices[current_year] = \
        calculate_annual_spot_price(
            self.negotiation_results[current_year]
        )

    # Existing: update_supply, produce,
    # calculate price, evaluate
    # ...

    # Modified invest: Check contract obligations first
    self.fulfill_contract_obligations()

    # Then normal investment for new plants
    for agent in self.schedule.agents:
        agent.invest()
\end{lstlisting}

\section{Implementation Phases}

\subsection{Phase 1: Core Price Discovery (No Contracts)}

\begin{enumerate}
    \item Create \texttt{src/price\_discovery.py}
    \item Implement \texttt{get\_utilization\_fraction()}
    \item Implement improved convergence formula
    \item Implement \texttt{run\_price\_discovery\_negotiation()}
    \item Write unit tests for price convergence
\end{enumerate}

\subsection{Phase 2: Contract Infrastructure}

\begin{enumerate}[start=6]
    \item Create \texttt{FeedstockContract} data class
    \item Add contract tracking to \texttt{FeedstockAggregator}
    \item Add contract tracking to \texttt{Investor}
    \item Add contract tracking to \texttt{Model}
\end{enumerate}

\subsection{Phase 3: Integration}

\begin{enumerate}[start=10]
    \item Modify \texttt{Model.step()} to run annual negotiations
    \item Implement \texttt{Investor.participate\_in\_negotiation()}
    \item Implement spot price calculation and storage
    \item Implement contract obligation fulfillment
\end{enumerate}

\subsection{Phase 4: Contract Behavior}

\begin{enumerate}[start=14]
    \item Implement \texttt{Investor.decide\_contract\_percentage()}
    \item Implement \texttt{Investor.purchase\_spot\_feedstock()}
    \item Update NPV calculation to account for dual pricing
    \item Modify feedstock allocation logic for contracted vs. available
\end{enumerate}

\subsection{Phase 5: Testing \& Validation}

\begin{enumerate}[start=18]
    \item Test single negotiation convergence
    \item Test multiple simultaneous negotiations (different aggregators)
    \item Test 20-year contract lifecycle
    \item Validate spot price averaging
    \item Verify no hardcoded behaviors (emergent only)
\end{enumerate}

\section{Key Configuration Parameters}

New parameters to add to \texttt{input/config.csv}:

\begin{table}[h]
\centering
\begin{tabular}{lll}
\hline
\textbf{Parameter} & \textbf{Value} & \textbf{Unit/Remarks} \\
\hline
\texttt{negotiation\_days} & 30 & Days for price discovery \\
\texttt{contract\_duration} & 20 & years \\
\texttt{contract\_percentage\_min} & 0.80 & Minimum contract coverage \\
\texttt{contract\_percentage\_max} & 0.90 & Maximum contract coverage \\
\texttt{utilization\_fraction\_start} & 0.05 & Initial capacity (year 1) \\
\texttt{utilization\_fraction\_max} & 0.60 & Maximum capacity (mature) \\
\texttt{utilization\_growth\_rate} & 0.03 & Annual increase \\
\texttt{price\_convergence\_alpha} & 10.0 & USD, base step size \\
\texttt{price\_convergence\_beta} & 0.1 & Dampening factor \\
\texttt{price\_convergence\_threshold} & 1.0 & USD, stop when $|\Delta p| < \epsilon$ \\
\hline
\end{tabular}
\end{table}

\section{Data Collection \& Visualization}

\subsection{New Metrics to Track}

\textbf{Model-Level:}
\begin{itemize}
    \item \texttt{Annual\_Spot\_Price}: Average negotiated price each year
    \item \texttt{Num\_Active\_Contracts}: Total contracts across all aggregators
    \item \texttt{Total\_Contracted\_Capacity}: Sum of capacity under contract
\end{itemize}

\textbf{Aggregator-Level:}
\begin{itemize}
    \item \texttt{Negotiation\_Final\_Price}: Result of this year's negotiation
    \item \texttt{Num\_Contracts}: Contracts held by this aggregator
    \item \texttt{Utilization\_Fraction}: Current capacity utilization
    \item \texttt{Available\_Capacity}: Uncontracted capacity
\end{itemize}

\textbf{Investor-Level:}
\begin{itemize}
    \item \texttt{Num\_Contracts}: Number of contracts held
    \item \texttt{Contract\_Percentage}: Chosen coverage (80--90\%)
    \item \texttt{Spot\_Purchase\_Volume}: Annual spot market purchases
    \item \texttt{Weighted\_Avg\_Feedstock\_Cost}: Blended contract + spot price
\end{itemize}

\section{Critical Design Principles}

\subsection{No Hardcoded Behaviors}

\textbf{Correct Approach:} Set rules and let behavior emerge naturally.
\begin{itemize}
    \item Investors calculate NPV and decide participation based on thresholds
    \item Market dynamics determine prices through iterative negotiation
    \item Spot vs. contract balance emerges from economic conditions
\end{itemize}

\textbf{Incorrect Approach:} Programmed strategies.
\begin{itemize}
    \item[$\times$] ``Investor always picks 90\% in year 1''
    \item[$\times$] ``Drop out if price $> X$''
    \item[$\times$] ``Strategic bidding algorithms''
\end{itemize}

\subsection{Natural Market Dynamics}

The following should emerge organically from the rules:
\begin{itemize}
    \item \textbf{Competition intensity} $\rightarrow$ from $N_{\text{target}}$ relative to interested investors
    \item \textbf{Price levels} $\rightarrow$ from investor NPV thresholds and aggregator supply constraints
    \item \textbf{Contract percentages} $\rightarrow$ investor choice (random or simple heuristic)
    \item \textbf{Spot market activity} $\rightarrow$ difference between contract and spot prices
\end{itemize}

\section{Edge Cases to Handle}

\begin{enumerate}
    \item \textbf{No investors interested:} Price decreases to floor, no contracts signed
    \item \textbf{All investors interested:} Price increases until $N_{\text{active}} \leq N_{\text{target}}$
    \item \textbf{Contract expiration:} Capacity becomes available again (greenfield/brownfield implementation deferred)
    \item \textbf{Multiple aggregators negotiating same year:} Independent negotiations, aggregate final prices for spot
    \item \textbf{Investor with multiple plants:} Each plant receives separate contract
    \item \textbf{Spot price when no negotiations occur:} Use previous year or default fallback
\end{enumerate}

\section{Success Criteria}

Implementation is complete when:

\begin{itemize}
    \item[$\checkmark$] Price discovery converges smoothly (no oscillations)
    \item[$\checkmark$] Oversupply scenario still creates competition (via utilization fraction)
    \item[$\checkmark$] Undersupply scenario naturally produces high prices
    \item[$\checkmark$] Contracts last 20 years with correct pricing structure
    \item[$\checkmark$] Spot market correctly averages multiple negotiations
    \item[$\checkmark$] 80--90\% contract + 10--20\% spot mechanism works correctly
    \item[$\checkmark$] No investor behaviors are hardcoded
    \item[$\checkmark$] Emergent market dynamics are realistic and interpretable
\end{itemize}

\section{Conclusion}

This implementation plan provides a comprehensive roadmap for introducing iterative price discovery and long-term contracts into the SAF Market Model. The approach addresses the oversupply challenge through strategic capacity utilization, ensures smooth price convergence through dampening mechanisms, and creates realistic market dynamics through a blend of long-term contracts and spot market transactions.

The phased implementation strategy allows for incremental development and testing, ensuring each component functions correctly before integration. By adhering to the principle of emergent behavior rather than hardcoded strategies, the model will produce realistic and interpretable market outcomes.

\textbf{Next Step:} Review and confirm understanding, then begin Phase 1 implementation.

\end{document}
